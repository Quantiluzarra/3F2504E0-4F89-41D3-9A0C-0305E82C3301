<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Multicolor Square</title>
<style>
  :root{
    --bg:#070a10;
    --panel: rgba(16,20,30,.62);
    --panel2: rgba(10,14,22,.72);
    --line: rgba(255,255,255,.10);
    --text: rgba(245,250,255,.92);
    --muted: rgba(190,205,223,.70);
    --a1:#6E7BFF;
    --a2:#20D2A2;
    --a3:#FF5CAD;
    --shadow: 0 28px 90px rgba(0,0,0,.6);
    --r: 18px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    --ease: cubic-bezier(.2,.85,.2,1);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: var(--sans);
    color: var(--text);
    background: var(--bg);
    overflow:hidden;
  }

  /* Infinite animated background */
  body::before{
    content:"";
    position: fixed;
    inset:-20%;
    z-index:-3;
    background:
      radial-gradient(820px 620px at 12% 15%, rgba(110,123,255,.34), transparent 62%),
      radial-gradient(820px 620px at 88% 20%, rgba(32,210,162,.22), transparent 64%),
      radial-gradient(820px 620px at 50% 92%, rgba(255,92,173,.18), transparent 62%),
      linear-gradient(-45deg, rgba(110,123,255,.15), rgba(32,210,162,.10), rgba(255,92,173,.10), rgba(110,123,255,.15));
    background-size: 160% 160%;
    filter: saturate(1.2) contrast(1.06);
    animation: bgMove 12s var(--ease) infinite alternate;
    transform: translateZ(0);
  }
  @keyframes bgMove{
    0%{ background-position: 0% 50%; transform: scale(1.02) rotate(-.15deg); }
    100%{ background-position: 100% 50%; transform: scale(1.06) rotate(.15deg); }
  }

  body::after{
    content:"";
    position: fixed;
    inset:0;
    z-index:-2;
    opacity:.26;
    background-image:
      repeating-linear-gradient( 90deg, rgba(255,255,255,.06) 0 1px, transparent 1px 44px),
      repeating-linear-gradient(180deg, rgba(255,255,255,.05) 0 1px, transparent 1px 44px),
      repeating-linear-gradient(-45deg, rgba(110,123,255,0) 0 18px, rgba(110,123,255,.12) 18px 19px, rgba(110,123,255,0) 19px 38px);
    background-size: 44px 44px, 44px 44px, 160px 160px;
    animation: gridFlow 26s linear infinite;
    mask-image: radial-gradient(circle at 50% 40%, black 0 58%, transparent 80%);
    pointer-events:none;
  }
  @keyframes gridFlow{
    from{ background-position: 0 0, 0 0, 0 0; }
    to{ background-position: -1200px 0, 0 -900px, 700px 300px; }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    body::before, body::after{ animation:none !important; }
  }

  /* Layout */
  .app{
    height:100%;
    display:grid;
    grid-template-columns: 340px 1fr;
    gap: 14px;
    padding: 14px;
  }
  @media (max-width: 980px){
    body{ overflow:auto; }
    .app{ grid-template-columns: 1fr; }
  }

  .panel{
    border: 1px solid var(--line);
    border-radius: var(--r);
    background: linear-gradient(180deg, var(--panel), var(--panel2));
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
    overflow:hidden;
  }

  .pHead{
    padding: 14px 14px 10px;
    border-bottom: 1px solid rgba(255,255,255,.09);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{
    width: 36px; height: 36px;
    border-radius: 14px;
    background: conic-gradient(from 180deg, var(--a1), var(--a2), var(--a3), var(--a1));
    box-shadow: 0 0 0 3px rgba(255,255,255,.06), 0 20px 60px rgba(110,123,255,.18);
    position:relative; overflow:hidden;
  }
  .logo::after{
    content:"";
    position:absolute; inset:-70%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 55%);
    animation: sheen 3.0s var(--ease) infinite;
  }
  @keyframes sheen{
    0%{ transform: translate3d(-12%, -10%, 0) rotate(8deg); opacity:.18; }
    50%{ transform: translate3d(12%, 10%, 0) rotate(18deg); opacity:.28; }
    100%{ transform: translate3d(-12%, -10%, 0) rotate(8deg); opacity:.18; }
  }
  @media (prefers-reduced-motion: reduce){ .logo::after{ animation:none !important; } }

  .name{
    margin:0;
    font-size: 14px;
    letter-spacing: 2.6px;
    text-transform: uppercase;
  }
  .mini{
    margin-top: 4px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--muted);
  }
  .pBody{ padding: 12px 14px 14px; display:grid; gap:10px; }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .field{
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    border-radius: 14px;
    padding: 10px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .lab{
    font-family: var(--mono);
    font-size: 12px;
    color: rgba(190,205,223,.70);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  input[type="range"]{ width:100%; }
  input[type="color"]{
    width: 100%;
    height: 34px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: transparent;
    padding: 0;
  }

  .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
  .btn{
    border: 1px solid rgba(110,123,255,.45);
    background: rgba(110,123,255,.14);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    font-size: 13px;
    user-select:none;
    position:relative;
    overflow:hidden;
    transition: transform 200ms var(--ease), background 200ms var(--ease), border-color 200ms var(--ease);
  }
  .btn:hover{ transform: translateY(-1px); background: rgba(110,123,255,.20); border-color: rgba(32,210,162,.40); }
  .btn:active{ transform: translateY(0) scale(.99); }
  .btn.ghost{
    border-color: rgba(255,255,255,.14);
    background: rgba(255,255,255,.04);
    color: var(--muted);
  }
  .btn.ghost:hover{ background: rgba(255,255,255,.06); color: var(--text); border-color: rgba(255,255,255,.20); }

  .toggle{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .sw{
    width: 44px; height: 26px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    position:relative;
    cursor:pointer;
    flex: 0 0 auto;
    transition: background 200ms var(--ease);
  }
  .sw i{
    position:absolute; top: 3px; left: 3px;
    width: 20px; height: 20px;
    border-radius: 999px;
    background: rgba(245,250,255,.85);
    box-shadow: 0 12px 24px rgba(0,0,0,.25);
    transition: transform 220ms var(--ease), background 220ms var(--ease);
  }
  .sw.on{ background: rgba(32,210,162,.14); border-color: rgba(32,210,162,.35); }
  .sw.on i{ transform: translateX(18px); background: rgba(32,210,162,.92); }

  .hint{
    font-family: var(--mono);
    font-size: 12px;
    color: rgba(190,205,223,.60);
    padding-top: 4px;
  }

  /* Canvas area */
  .stage{
    border: 1px solid var(--line);
    border-radius: var(--r);
    background: rgba(0,0,0,.16);
    box-shadow: var(--shadow);
    position: relative;
    overflow:hidden;
    min-height: 520px;
  }
  .stageInner{
    position:absolute;
    inset:0;
    display:grid;
    place-items:center;
  }
  .canWrap{
    position: relative;
    transform: translateZ(0);
    will-change: transform;
  }
  canvas{
    display:block;
    border-radius: 14px;
    background: #0b0f17;
    box-shadow: 0 26px 80px rgba(0,0,0,.55);
    touch-action: none;
  }

  /* Developer channel link (bottom-left) */
  .devlink{
    position: fixed;
    left: 14px;
    bottom: 14px;
    z-index: 40;
    font-family: "Trebuchet MS", var(--sans);
    font-size: 13px;
    letter-spacing: 1.4px;
    text-transform: uppercase;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(10,14,22,.55);
    backdrop-filter: blur(12px);
    box-shadow: 0 18px 55px rgba(0,0,0,.35);
    color: rgba(245,250,255,.92);
    text-decoration: none;
    user-select:none;
    overflow:hidden;
  }
  .devlink::before{
    content:"";
    position:absolute;
    inset:-60%;
    background: conic-gradient(from 180deg, rgba(110,123,255,.45), rgba(32,210,162,.35), rgba(255,92,173,.35), rgba(110,123,255,.45));
    filter: blur(16px);
    opacity:.55;
    animation: devGlow 2.6s var(--ease) infinite alternate;
    pointer-events:none;
  }
  .devlink span{ position:relative; }
  @keyframes devGlow{
    from{ transform: translate3d(-2%, -2%, 0); opacity:.42; }
    to{ transform: translate3d(2%, 2%, 0); opacity:.62; }
  }
  .devlink:hover{ border-color: rgba(32,210,162,.35); transform: translateY(-1px); }
  .devlink:active{ transform: translateY(0); }

  /* Toast */
  .toast{
    position: fixed;
    right: 14px;
    bottom: 14px;
    z-index: 50;
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 16px;
    background: rgba(10,14,22,.78);
    backdrop-filter: blur(12px);
    padding: 10px 12px;
    display:none;
    box-shadow: 0 20px 60px rgba(0,0,0,.45);
    min-width: min(360px, calc(100vw - 28px));
  }
  .toast.show{ display:block; animation: toastIn 220ms var(--ease) both; }
  @keyframes toastIn{
    from{ transform: translateY(10px); opacity: 0; }
    to{ transform: translateY(0); opacity: 1; }
  }
  .toast .t1{ font-size: 13px; }
  .toast .t2{ margin-top: 6px; font-family: var(--mono); font-size: 12px; color: rgba(190,205,223,.70); }

  /* ====== LOADER ====== */
  .loader{
    position: fixed;
    inset: 0;
    z-index: 999;
    display:grid;
    place-items:center;
    background:
      radial-gradient(900px 650px at 15% 20%, rgba(110,123,255,.26), transparent 62%),
      radial-gradient(900px 650px at 85% 25%, rgba(32,210,162,.18), transparent 64%),
      radial-gradient(900px 650px at 50% 90%, rgba(255,92,173,.14), transparent 62%),
      rgba(0,0,0,.82);
    backdrop-filter: blur(10px);
    transition: opacity 700ms var(--ease), transform 700ms var(--ease);
  }
  .loader.hide{
    opacity: 0;
    pointer-events:none;
    transform: scale(1.02);
  }

  .loadCard{
    width: min(720px, calc(100vw - 34px));
    border-radius: 26px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(10,14,22,.55);
    box-shadow: 0 40px 150px rgba(0,0,0,.65);
    backdrop-filter: blur(16px);
    padding: 18px 16px 14px;
    position: relative;
    overflow:hidden;
  }
  .loadCard::before{
    content:"";
    position:absolute;
    inset:-80%;
    background: conic-gradient(from 180deg, rgba(110,123,255,.55), rgba(32,210,162,.45), rgba(255,92,173,.45), rgba(110,123,255,.55));
    filter: blur(26px);
    opacity:.55;
    animation: loadAura 3.4s var(--ease) infinite alternate;
  }
  @keyframes loadAura{
    from{ transform: translate3d(-2%, -2%, 0); opacity:.38; }
    to{ transform: translate3d(2%, 2%, 0); opacity:.64; }
  }

  .loadTop{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .loadBrand{
    display:flex; align-items:center; gap:12px;
  }
  .loadMark{
    width: 44px; height: 44px;
    border-radius: 16px;
    background: conic-gradient(from 180deg, var(--a1), var(--a2), var(--a3), var(--a1));
    box-shadow: 0 0 0 3px rgba(255,255,255,.06), 0 26px 85px rgba(110,123,255,.20);
    position:relative; overflow:hidden;
  }
  .loadMark::after{
    content:"";
    position:absolute; inset:-70%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 55%);
    animation: sheen 2.6s var(--ease) infinite;
  }

  .loadTitle{
    margin:0;
    font-size: 14px;
    letter-spacing: 3.2px;
    text-transform: uppercase;
  }
  .loadSub{
    margin-top: 4px;
    font-family: var(--mono);
    font-size: 12px;
    color: rgba(190,205,223,.72);
  }

  .ring{
    width: 62px; height: 62px;
    position:relative;
    flex: 0 0 auto;
    filter: drop-shadow(0 18px 55px rgba(0,0,0,.35));
  }
  .ring svg{
    width: 62px; height: 62px;
    transform: rotate(-90deg);
    display:block;
  }
  .ring .bg{
    stroke: rgba(255,255,255,.12);
  }
  .ring .fg{
    stroke: url(#grad);
    stroke-linecap: round;
    stroke-dasharray: 188.4;
    stroke-dashoffset: 188.4;
    animation: ringProg 6.8s linear forwards;
  }
  @keyframes ringProg{ to{ stroke-dashoffset: 0; } }

  .bar{
    position:relative;
    margin-top: 14px;
    height: 12px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    overflow:hidden;
  }
  .bar > i{
    display:block;
    height:100%;
    width: 0%;
    border-radius: 999px;
    background: linear-gradient(90deg, rgba(110,123,255,.95), rgba(32,210,162,.95), rgba(255,92,173,.95));
    box-shadow:
      0 0 18px rgba(110,123,255,.30),
      0 0 22px rgba(32,210,162,.18),
      0 0 22px rgba(255,92,173,.14);
    animation: barProg 6.8s linear forwards;
  }
  @keyframes barProg{ to{ width: 100%; } }

  .bar::after{
    content:"";
    position:absolute;
    inset:-60% -30%;
    background: radial-gradient(circle at 30% 40%, rgba(255,255,255,.22), transparent 55%);
    transform: rotate(10deg);
    animation: barSheen 1.6s var(--ease) infinite;
    opacity:.55;
    pointer-events:none;
  }
  @keyframes barSheen{
    0%{ transform: translate3d(-30%, -12%, 0) rotate(10deg); }
    50%{ transform: translate3d(30%, 12%, 0) rotate(18deg); }
    100%{ transform: translate3d(-30%, -12%, 0) rotate(10deg); }
  }

  .loadFoot{
    position:relative;
    margin-top: 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .pct{
    font-family: var(--mono);
    font-size: 12px;
    color: rgba(190,205,223,.75);
  }
  .skip{
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.04);
    color: rgba(245,250,255,.86);
    padding: 9px 11px;
    border-radius: 999px;
    cursor:pointer;
    font-size: 12px;
    font-family: var(--mono);
    display:none;
  }
  .skip.show{ display:inline-flex; }

  /* Reduced motion for loader too */
  @media (prefers-reduced-motion: reduce){
    .loadCard::before, .bar::after, .ring .fg, .bar > i{ animation:none !important; }
  }
</style>
</head>

<body>

  <!-- Loader overlay -->
  <div class="loader" id="loader" aria-label="Loading">
    <div class="loadCard">
      <div class="loadTop">
        <div class="loadBrand">
          <div class="loadMark" aria-hidden="true"></div>
          <div>
            <h2 class="loadTitle">MULTICOLOR SQUARE</h2>
            <div class="loadSub">initializing canvas • shaders • grid</div>
          </div>
        </div>

        <div class="ring" aria-hidden="true">
          <svg viewBox="0 0 72 72" fill="none">
            <defs>
              <linearGradient id="grad" x1="0" y1="0" x2="72" y2="72">
                <stop offset="0" stop-color="#6E7BFF"/>
                <stop offset="0.55" stop-color="#20D2A2"/>
                <stop offset="1" stop-color="#FF5CAD"/>
              </linearGradient>
            </defs>
            <circle class="bg" cx="36" cy="36" r="30" stroke-width="6"/>
            <circle class="fg" cx="36" cy="36" r="30" stroke-width="6"/>
          </svg>
        </div>
      </div>

      <div class="bar" aria-hidden="true"><i></i></div>

      <div class="loadFoot">
        <div class="pct" id="pct">0%</div>
        <button class="skip" id="skip" type="button">SKIP</button>
      </div>
    </div>
  </div>

  <!-- Developer channel (bottom-left) -->
  <a class="devlink" href="https://t.me/imertinros" target="_blank" rel="noopener noreferrer">
    <span>Developer channel</span>
  </a>

  <div class="app" id="app" style="visibility:hidden;">
    <!-- Left: settings -->
    <aside class="panel" aria-label="Settings">
      <div class="pHead">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1 class="name">MULTICOLOR SQUARE</h1>
            <div class="mini">pixel canvas</div>
          </div>
        </div>
        <button class="btn ghost" id="newBtn" type="button" title="New">New</button>
      </div>

      <div class="pBody">
        <div class="row">
          <div class="field">
            <div class="lab"><span>Grid</span><span id="gridVal">48</span></div>
            <input id="grid" type="range" min="16" max="160" value="48" step="1" />
          </div>
          <div class="field">
            <div class="lab"><span>Brush</span><span id="brushVal">1</span></div>
            <input id="brush" type="range" min="1" max="8" value="1" step="1" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <div class="lab"><span>Color</span><span id="hexOut">#20D2A2</span></div>
            <input id="color" type="color" value="#20D2A2"/>
          </div>
          <div class="field">
            <div class="lab"><span>Zoom</span><span id="zoomVal">100%</span></div>
            <input id="zoom" type="range" min="60" max="180" value="100" step="1" />
          </div>
        </div>

        <div class="field">
          <div class="toggle">
            <div class="lab" style="margin:0;"><span>Rainbow</span><span id="rbHint"></span></div>
            <div class="sw" id="rb"><i></i></div>
          </div>
          <div class="toggle" style="margin-top:10px;">
            <div class="lab" style="margin:0;"><span>Eraser</span><span></span></div>
            <div class="sw" id="er"><i></i></div>
          </div>
          <div class="toggle" style="margin-top:10px;">
            <div class="lab" style="margin:0;"><span>Grid lines</span><span></span></div>
            <div class="sw on" id="gl"><i></i></div>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn ghost" id="undoBtn" type="button">Undo</button>
          <button class="btn ghost" id="redoBtn" type="button">Redo</button>
          <button class="btn ghost" id="clearBtn" type="button">Clear</button>
          <button class="btn" id="saveBtn" type="button">Save PNG</button>
        </div>

        <div class="btnRow">
          <button class="btn ghost" id="exportBtn" type="button">Export</button>
          <button class="btn ghost" id="importBtn" type="button">Import</button>
          <input id="fileIn" type="file" accept="application/json" style="display:none;">
        </div>

        <div class="hint">
          Draw: hold LMB + move • Touch: draw with finger
        </div>
      </div>
    </aside>

    <!-- Right: canvas -->
    <section class="stage panel" aria-label="Canvas">
      <div class="stageInner">
        <div class="canWrap" id="canWrap">
          <canvas id="paint"></canvas>
          <canvas id="gridOverlay"></canvas>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="t1" id="t1">OK</div>
    <div class="t2" id="t2">…</div>
  </div>

<script>
(() => {
  const $ = (s, r=document) => r.querySelector(s);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  // ===== Loader (long + real animation) =====
  const loader = $('#loader');
  const app = $('#app');
  const pctEl = $('#pct');
  const skipBtn = $('#skip');

  const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const LOAD_MS = prefersReduce ? 900 : 6800;   // long loading by default
  const SKIP_AFTER = prefersReduce ? 0 : 2400;  // show skip after a bit

  let start = performance.now();
  let raf = 0;

  function tick(t){
    const p = clamp((t - start) / LOAD_MS, 0, 1);
    const eased = 1 - Math.pow(1 - p, 3); // easeOutCubic
    const shown = Math.floor(eased * 100);
    pctEl.textContent = shown + '%';
    if(p < 1){
      raf = requestAnimationFrame(tick);
    }else{
      finishLoader();
    }
  }

  function finishLoader(){
    cancelAnimationFrame(raf);
    app.style.visibility = 'visible';
    loader.classList.add('hide');
    setTimeout(()=> loader.remove(), 900);
  }

  setTimeout(() => skipBtn.classList.add('show'), SKIP_AFTER);
  skipBtn.addEventListener('click', finishLoader);

  requestAnimationFrame(tick);

  // ===== Painting app (same core as before) =====
  const canvas = $('#paint');
  const ctx = canvas.getContext('2d', { alpha: false });
  const gridCanvas = $('#gridOverlay');
  const gctx = gridCanvas.getContext('2d');

  const gridSlider = $('#grid');
  const brushSlider = $('#brush');
  const zoomSlider = $('#zoom');
  const colorPicker = $('#color');

  const gridVal = $('#gridVal');
  const brushVal = $('#brushVal');
  const zoomVal = $('#zoomVal');
  const hexOut = $('#hexOut');

  const rbSw = $('#rb');
  const erSw = $('#er');
  const glSw = $('#gl');

  const newBtn = $('#newBtn');
  const undoBtn = $('#undoBtn');
  const redoBtn = $('#redoBtn');
  const clearBtn = $('#clearBtn');
  const saveBtn = $('#saveBtn');
  const exportBtn = $('#exportBtn');
  const importBtn = $('#importBtn');
  const fileIn = $('#fileIn');

  const canWrap = $('#canWrap');

  const toastEl = $('#toast');
  const t1 = $('#t1');
  const t2 = $('#t2');
  let toastTimer = 0;
  function toast(a, b=''){
    t1.textContent = a; t2.textContent = b;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 2200);
  }

  let N = +gridSlider.value;
  let brush = +brushSlider.value;
  let zoom = +zoomSlider.value / 100;
  let showGrid = true;
  let rainbow = false;
  let eraser = false;

  const BG = 0x0b0f17;
  let pixels = new Uint32Array(N*N);
  pixels.fill(BG);

  const undo = [];
  const redo = [];
  const MAX_STACK = 60;

  let drawing = false;
  let lastCell = -1;
  let currentAction = null;

  function hexToRgbInt(hex){
    const s = hex.replace('#','').trim();
    const v = parseInt(s, 16);
    return v & 0xFFFFFF;
  }
  function hslToRgbInt(h, s, l){
    h = ((h % 360) + 360) % 360;
    const c = (1 - Math.abs(2*l - 1)) * s;
    const x = c * (1 - Math.abs(((h/60) % 2) - 1));
    const m = l - c/2;
    let r=0,g=0,b=0;
    if(h < 60){ r=c; g=x; b=0; }
    else if(h < 120){ r=x; g=c; b=0; }
    else if(h < 180){ r=0; g=c; b=x; }
    else if(h < 240){ r=0; g=x; b=c; }
    else if(h < 300){ r=x; g=0; b=c; }
    else { r=c; g=0; b=x; }
    const R = Math.round((r+m)*255);
    const G = Math.round((g+m)*255);
    const B = Math.round((b+m)*255);
    return (R<<16) | (G<<8) | B;
  }

  function setSwitch(sw, on){ sw.classList.toggle('on', !!on); }

  function updateUI(){
    gridVal.textContent = String(N);
    brushVal.textContent = String(brush);
    zoomVal.textContent = Math.round(zoom*100) + '%';
    hexOut.textContent = colorPicker.value.toUpperCase();
    setSwitch(rbSw, rainbow);
    setSwitch(erSw, eraser);
    setSwitch(glSw, showGrid);
  }

  function calcCanvasSize(){
    const stage = document.querySelector('.stage');
    const r = stage.getBoundingClientRect();
    const pad = 26;
    const size = Math.max(280, Math.min(r.width - pad, r.height - pad));
    return Math.floor(size);
  }

  function setupCanvases(){
    const size = calcCanvasSize();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

    canvas.width = Math.floor(size * dpr);
    canvas.height = Math.floor(size * dpr);
    canvas.style.width = size + 'px';
    canvas.style.height = size + 'px';

    gridCanvas.width = canvas.width;
    gridCanvas.height = canvas.height;
    gridCanvas.style.width = canvas.style.width;
    gridCanvas.style.height = canvas.style.height;

    ctx.setTransform(dpr,0,0,dpr,0,0);
    gctx.setTransform(dpr,0,0,dpr,0,0);

    canWrap.style.transform = `scale(${zoom})`;
    drawAll();
    drawGrid();
  }

  function drawAll(){
    const size = parseFloat(canvas.style.width) || 600;
    const cs = size / N;

    ctx.fillStyle = '#' + BG.toString(16).padStart(6,'0');
    ctx.fillRect(0,0,size,size);

    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const idx = y*N + x;
        const col = pixels[idx];
        if(col === BG) continue;
        ctx.fillStyle = '#' + (col>>>0).toString(16).padStart(6,'0');
        ctx.fillRect(x*cs, y*cs, cs, cs);
      }
    }
  }

  function drawGrid(){
    const size = parseFloat(gridCanvas.style.width) || 600;
    const cs = size / N;

    gctx.clearRect(0,0,size,size);
    if(!showGrid) return;

    gctx.globalAlpha = 0.55;
    gctx.lineWidth = 1;
    gctx.strokeStyle = 'rgba(255,255,255,.10)';

    let step = 1;
    if(N >= 96) step = 2;
    if(N >= 128) step = 4;

    gctx.beginPath();
    for(let i=0;i<=N;i+=step){
      const p = i*cs;
      gctx.moveTo(p, 0); gctx.lineTo(p, size);
      gctx.moveTo(0, p); gctx.lineTo(size, p);
    }
    gctx.stroke();
    gctx.globalAlpha = 1;
  }

  function paintCell(x, y, col){
    if(x < 0 || y < 0 || x >= N || y >= N) return;
    const idx = y*N + x;
    const prev = pixels[idx];
    if(prev === col) return;

    if(currentAction){
      if(!currentAction.seen.has(idx)){
        currentAction.seen.add(idx);
        currentAction.idxs.push(idx);
        currentAction.prev.push(prev);
        currentAction.next.push(col);
      }
    }

    pixels[idx] = col;

    const size = parseFloat(canvas.style.width) || 600;
    const cs = size / N;
    ctx.fillStyle = '#' + (col>>>0).toString(16).padStart(6,'0');
    ctx.fillRect(x*cs, y*cs, cs, cs);
  }

  function paintBrush(cx, cy){
    const half = Math.floor(brush / 2);
    const base = eraser ? BG : hexToRgbInt(colorPicker.value);
    const t = performance.now() * 0.001;

    for(let dy=-half; dy< -half+brush; dy++){
      for(let dx=-half; dx< -half+brush; dx++){
        const x = cx + dx;
        const y = cy + dy;

        let col = base;
        if(rainbow && !eraser){
          const hue = (t*90 + (x*9) + (y*7)) % 360;
          col = hslToRgbInt(hue, 1.0, 0.55);
        }
        paintCell(x, y, col);
      }
    }
  }

  function posToCell(e){
    const rect = canvas.getBoundingClientRect();
    const size = rect.width;
    const cs = size / N;
    const x = Math.floor((e.clientX - rect.left) / cs);
    const y = Math.floor((e.clientY - rect.top) / cs);
    return { x, y };
  }

  function beginStroke(){ currentAction = { idxs:[], prev:[], next:[], seen: new Set() }; }
  function endStroke(){
    if(!currentAction) return;
    if(currentAction.idxs.length){
      undo.push({ idxs: currentAction.idxs, prev: currentAction.prev, next: currentAction.next });
      if(undo.length > MAX_STACK) undo.shift();
      redo.length = 0;
    }
    currentAction = null;
  }

  function doUndo(){
    const a = undo.pop();
    if(!a) return;
    for(let i=0;i<a.idxs.length;i++) pixels[a.idxs[i]] = a.prev[i];
    redo.push(a);
    drawAll();
    toast('Undo', `${a.idxs.length} cells`);
  }
  function doRedo(){
    const a = redo.pop();
    if(!a) return;
    for(let i=0;i<a.idxs.length;i++) pixels[a.idxs[i]] = a.next[i];
    undo.push(a);
    drawAll();
    toast('Redo', `${a.idxs.length} cells`);
  }

  function clearAll(){
    const prev = Array.from(pixels);
    pixels.fill(BG);
    drawAll();
    undo.push({ idxs: prev.map((_,i)=>i), prev, next: Array(prev.length).fill(BG) });
    if(undo.length > MAX_STACK) undo.shift();
    redo.length = 0;
    toast('Clear', 'Canvas reset');
  }

  function newCanvas(){
    undo.length = 0; redo.length = 0;
    pixels = new Uint32Array(N*N);
    pixels.fill(BG);
    drawAll();
    drawGrid();
    toast('New', `${N}×${N}`);
  }

  function savePNG(){
    const cellPx = 20;
    const outSize = N * cellPx;
    const off = document.createElement('canvas');
    off.width = outSize;
    off.height = outSize;
    const o = off.getContext('2d', { alpha: false });

    o.fillStyle = '#' + BG.toString(16).padStart(6,'0');
    o.fillRect(0,0,outSize,outSize);

    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const idx = y*N + x;
        const col = pixels[idx];
        if(col === BG) continue;
        o.fillStyle = '#' + (col>>>0).toString(16).padStart(6,'0');
        o.fillRect(x*cellPx, y*cellPx, cellPx, cellPx);
      }
    }

    const url = off.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    a.download = `multicolor-square_${N}x${N}.png`;
    a.click();
    toast('Saved', a.download);
  }

  function exportJSON(){
    const payload = { app:'Multicolor Square', v:1, N, BG, pixels: Array.from(pixels) };
    const blob = new Blob([JSON.stringify(payload)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `multicolor-square_${N}x${N}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Export', a.download);
  }

  async function importJSONFile(file){
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!data || data.app !== 'Multicolor Square' || !Number.isFinite(data.N) || !Array.isArray(data.pixels)){
        toast('Import', 'Invalid file'); return;
      }
      N = clamp(data.N|0, 16, 160);
      gridSlider.value = String(N);
      pixels = new Uint32Array(N*N);
      const arr = data.pixels;
      for(let i=0;i<pixels.length;i++) pixels[i] = (arr[i] >>> 0) & 0xFFFFFF;
      undo.length = 0; redo.length = 0;
      updateUI();
      setupCanvases();
      toast('Import', `${N}×${N}`);
    }catch(e){
      toast('Import', 'Error');
    }
  }

  // Pointer drawing
  canvas.addEventListener('pointerdown', (e) => {
    canvas.setPointerCapture(e.pointerId);
    drawing = true;
    lastCell = -1;
    beginStroke();
    const {x,y} = posToCell(e);
    lastCell = y*N + x;
    paintBrush(x,y);
  });

  canvas.addEventListener('pointermove', (e) => {
    if(!drawing) return;
    const {x,y} = posToCell(e);
    const cell = y*N + x;
    if(cell === lastCell) return;
    lastCell = cell;
    paintBrush(x,y);
  });

  const end = () => { if(!drawing) return; drawing = false; lastCell = -1; endStroke(); };
  canvas.addEventListener('pointerup', end);
  canvas.addEventListener('pointercancel', end);

  // Controls
  gridSlider.addEventListener('input', () => { N = +gridSlider.value; updateUI(); });
  gridSlider.addEventListener('change', () => { newCanvas(); setupCanvases(); });

  brushSlider.addEventListener('input', () => { brush = +brushSlider.value; updateUI(); });
  zoomSlider.addEventListener('input', () => {
    zoom = +zoomSlider.value / 100;
    updateUI();
    canWrap.style.transform = `scale(${zoom})`;
  });

  colorPicker.addEventListener('input', () => {
    hexOut.textContent = colorPicker.value.toUpperCase();
    if(eraser){ eraser = false; setSwitch(erSw, eraser); }
  });

  rbSw.addEventListener('click', () => { rainbow = !rainbow; setSwitch(rbSw, rainbow); toast('Rainbow', rainbow ? 'ON' : 'OFF'); });
  erSw.addEventListener('click', () => { eraser = !eraser; setSwitch(erSw, eraser); toast('Eraser', eraser ? 'ON' : 'OFF'); });
  glSw.addEventListener('click', () => { showGrid = !showGrid; setSwitch(glSw, showGrid); drawGrid(); toast('Grid lines', showGrid ? 'ON' : 'OFF'); });

  newBtn.addEventListener('click', () => { if(confirm('New canvas?')) newCanvas(); });
  undoBtn.addEventListener('click', doUndo);
  redoBtn.addEventListener('click', doRedo);
  clearBtn.addEventListener('click', () => { if(confirm('Clear?')) clearAll(); });
  saveBtn.addEventListener('click', savePNG);
  exportBtn.addEventListener('click', exportJSON);
  importBtn.addEventListener('click', () => fileIn.click());
  fileIn.addEventListener('change', () => {
    const f = fileIn.files && fileIn.files[0];
    if(f) importJSONFile(f);
    fileIn.value = '';
  });

  // Hotkeys
  window.addEventListener('keydown', (e) => {
    const mod = e.ctrlKey || e.metaKey;
    if(mod && e.key.toLowerCase() === 'z'){ e.preventDefault(); doUndo(); }
    if(mod && (e.key.toLowerCase() === 'y' || (e.shiftKey && e.key.toLowerCase() === 'z'))){ e.preventDefault(); doRedo(); }
    if(e.key.toLowerCase() === 'e'){ eraser = !eraser; setSwitch(erSw, eraser); }
    if(e.key.toLowerCase() === 'r'){ rainbow = !rainbow; setSwitch(rbSw, rainbow); }
  });

  // Init
  updateUI();
  setupCanvases();
  let resizeT = 0;
  window.addEventListener('resize', () => {
    clearTimeout(resizeT);
    resizeT = setTimeout(setupCanvases, 120);
  });

  toast('Ready', 'Draw with LMB');
})();
</script>
</body>
</html>
